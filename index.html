<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareWithCNR</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                            700: '#4338ca',
                        },
                        dark: '#0f172a'
                    }
                }
            }
        }
    </script>

    <style>
        /* Cosmic Background */
        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #f8fafc;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        
        /* Dark Glass for Search/Inputs */
        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Stylish Nav Background */
        .nav-glass {
            background: rgba(15, 23, 42, 0.85); 
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Page Transitions */
        .hidden-page {
            display: none;
            opacity: 0;
            transform: scale(0.95);
        }
        .active-page {
            display: block;
            opacity: 1;
            transform: scale(1);
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* FAB Button Animation */
        .fab-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .fab-btn:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.6);
        }
        .fab-btn:active {
            transform: scale(0.9);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased selection:bg-brand-500 selection:text-white">

    <div id="actionModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300">
        <div class="glass-panel p-8 rounded-2xl max-w-sm w-full mx-4 text-center transform transition-all scale-100 shadow-2xl shadow-brand-500/20 relative">
            
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>

            <div class="w-16 h-16 bg-brand-50 rounded-full flex items-center justify-center mx-auto mb-4 text-brand-600">
                <i class="fa-solid fa-unlock-keyhole text-2xl"></i>
            </div>
            
            <h3 class="text-xl font-bold text-gray-800 mb-1">Access Granted</h3>
            <p id="modalFileName" class="text-sm text-gray-500 font-medium mb-6 truncate px-2">filename.pdf</p>
            
            <div class="space-y-6">
                <a id="downloadLink" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-semibold transition shadow-lg shadow-brand-500/30">
                    <i class="fa-solid fa-download"></i> Download File
                </a>
                
                <div class="pt-4 border-t border-gray-200/60">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Rate our Service</p>
                    
                    <div id="starContainer" class="flex justify-center gap-2" onmouseleave="resetStars()">
                        <button onclick="submitRating(1)" onmouseenter="highlightStars(1)" class="star-btn transition transform hover:scale-125 focus:outline-none">
                            <i class="fa-regular fa-star text-2xl text-gray-300 transition-colors duration-200"></i>
                        </button>
                        <button onclick="submitRating(2)" onmouseenter="highlightStars(2)" class="star-btn transition transform hover:scale-125 focus:outline-none">
                            <i class="fa-regular fa-star text-2xl text-gray-300 transition-colors duration-200"></i>
                        </button>
                        <button onclick="submitRating(3)" onmouseenter="highlightStars(3)" class="star-btn transition transform hover:scale-125 focus:outline-none">
                            <i class="fa-regular fa-star text-2xl text-gray-300 transition-colors duration-200"></i>
                        </button>
                        <button onclick="submitRating(4)" onmouseenter="highlightStars(4)" class="star-btn transition transform hover:scale-125 focus:outline-none">
                            <i class="fa-regular fa-star text-2xl text-gray-300 transition-colors duration-200"></i>
                        </button>
                        <button onclick="submitRating(5)" onmouseenter="highlightStars(5)" class="star-btn transition transform hover:scale-125 focus:outline-none">
                            <i class="fa-regular fa-star text-2xl text-gray-300 transition-colors duration-200"></i>
                        </button>
                    </div>
                    <p id="ratingMessage" class="text-xs text-brand-600 font-bold h-4 mt-2 opacity-0 transition-opacity duration-300">Thanks for rating!</p>
                </div>
                </div>
        </div>
    </div>

    <nav class="sticky top-0 z-50 nav-glass">
        <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-gradient-to-tr from-brand-600 to-purple-500 flex items-center justify-center text-white shadow-lg shadow-brand-500/20">
                    <i class="fa-solid fa-share-nodes"></i>
                </div>
                <h1 class="text-xl font-bold text-white tracking-wide drop-shadow-sm">ShareWithCNR</h1>
            </div>
            <div class="hidden sm:flex items-center gap-2 text-xs font-semibold text-gray-300 bg-white/10 px-3 py-1.5 rounded-full border border-white/5">
                <i class="fa-regular fa-clock text-brand-400"></i> Files expire in 48h
            </div>
        </div>
    </nav>

    <main class="flex-grow container max-w-3xl mx-auto px-4 py-8 relative z-10">
        
        <div id="feedSection" class="active-page">
            <div class="flex flex-col items-center mb-8 text-center text-white">
                <h2 class="text-3xl font-bold mb-2 drop-shadow-md">Available Files</h2>
                <p class="text-gray-300 text-sm max-w-md">Secure any materials. Shared temporarily.</p>
            </div>

            <div class="max-w-md mx-auto mb-8 relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fa-solid fa-magnifying-glass text-gray-400 group-focus-within:text-brand-400 transition-colors"></i>
                </div>
                <input type="text" id="searchInput" onkeyup="filterFiles()" placeholder="Search files by name..." 
                    class="block w-full pl-11 pr-4 py-3 rounded-xl glass-dark text-white placeholder-gray-400 border border-white/10 focus:border-brand-500/50 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all">
            </div>

            <div id="loader" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-white/20 border-t-brand-500"></div>
                <p class="mt-4 text-white/70 text-sm font-medium animate-pulse">Loading secure feed...</p>
            </div>

            <div id="feed" class="space-y-4 pb-24">
                </div>
        </div>

        <div id="uploadSection" class="hidden-page">
            <div class="max-w-lg mx-auto">
                <button onclick="toggleView('feed')" class="mb-6 flex items-center text-white/80 hover:text-white transition group">
                    <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center mr-3 group-hover:bg-white/20 transition">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                    </div>
                    <span class="font-medium">Back to Feed</span>
                </button>

                <div class="glass-panel rounded-2xl p-8 shadow-2xl">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-brand-50 text-brand-600 mb-4 shadow-inner">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Upload New File</h2>
                        <p class="text-gray-500 text-sm mt-1">Encrypted & Password Protected</p>
                    </div>

                    <div class="space-y-5">
                        <div class="group">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">File Title</label>
                            <input type="text" id="filename" placeholder="e.g. Physics Notes" 
                                class="w-full px-4 py-3.5 rounded-xl bg-gray-50 border-2 border-gray-100 focus:border-brand-500 focus:bg-white outline-none transition font-medium text-gray-700">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Attachment</label>
                            <input type="file" id="file" class="hidden" onchange="updateFileName(this)">
                            <label for="file" class="flex flex-col items-center justify-center w-full h-28 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-brand-500 hover:bg-brand-50/50 transition">
                                <div class="flex flex-col items-center justify-center pt-2 pb-3">
                                    <i class="fa-solid fa-folder-open text-2xl text-gray-400 mb-2"></i>
                                    <p id="fileLabel" class="text-sm text-gray-500 font-medium">Click to choose file</p>
                                </div>
                            </label>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Set Password</label>
                            <input type="password" id="password" placeholder="Create a password" 
                                class="w-full px-4 py-3.5 rounded-xl bg-gray-50 border-2 border-gray-100 focus:border-brand-500 focus:bg-white outline-none transition font-medium text-gray-700">
                        </div>

                        <button id="uploadBtn" class="w-full py-4 mt-2 bg-gradient-to-r from-brand-600 to-indigo-600 hover:from-brand-700 hover:to-indigo-700 text-white font-bold text-lg rounded-xl shadow-lg shadow-brand-500/30 transform transition-all active:scale-[0.98]">
                            Upload
                        </button>
                        
                        <div id="progressContainer" class="hidden mt-4">
                            <div class="flex justify-between text-xs font-bold text-gray-500 mb-1">
                                <span>Uploading...</span>
                                <span id="progressText">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                <div id="progressBar" class="bg-brand-600 h-2.5 rounded-full transition-all duration-75" style="width: 0%"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="fabContainer" class="fixed bottom-8 left-8 z-40">
        <button onclick="confirmAddFile()" class="fab-btn w-14 h-14 rounded-full bg-gradient-to-tr from-brand-600 to-indigo-500 text-white flex items-center justify-center shadow-2xl border-2 border-white/20">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>
    </div>

    <footer class="glass-panel border-t border-gray-200 mt-auto relative z-20">
        <div class="max-w-4xl mx-auto px-6 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                
                <div class="text-center md:text-left">
                    <h3 class="font-bold text-lg text-gray-800">ShareWithCNR</h3>
                    <p class="text-xs text-gray-400 mt-1">&copy; 2025 CNR. All rights reserved.</p>
                </div>

                <div class="flex gap-3">
                    <a href="https://github.com/yourkrishna5" target="_blank" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-black hover:text-white transition"><i class="fa-brands fa-github"></i></a>
                    <a href="https://www.iamcnr.netlify.app" target="_blank" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-blue-600 hover:text-white transition"><i class="fa-solid fa-globe"></i></a>
                    <a href="https://instagram.com/beyondcnr" target="_blank" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-pink-600 hover:text-white transition"><i class="fa-brands fa-instagram"></i></a>
                    <a href="https://facebook.com/neocnrkm10" target="_blank" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-blue-700 hover:text-white transition"><i class="fa-brands fa-facebook-f"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://sofxdshwkkwtfxnmlzem.supabase.co';
        const supabaseKey = 'sb_publishable_VMNVZXmmep05ihMaYjC9ug_FDxfoPL3';
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        const cloudName = "du1wbgmmh";
        const uploadPreset = "fbpost"; 

        document.getElementById("uploadBtn").addEventListener("click", upload);
        fetchFeed();

        // Utility to format bytes to readable size
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // ----- View Toggle Logic -----
        window.toggleView = function(viewName) {
            const feedSection = document.getElementById('feedSection');
            const uploadSection = document.getElementById('uploadSection');
            const fab = document.getElementById('fabContainer');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (viewName === 'upload') {
                fab.style.display = 'none';
                feedSection.classList.remove('active-page');
                feedSection.classList.add('hidden-page');
                uploadSection.classList.remove('hidden-page');
                setTimeout(() => uploadSection.classList.add('active-page'), 10);
            } else {
                fab.style.display = 'block';
                uploadSection.classList.remove('active-page');
                uploadSection.classList.add('hidden-page');
                feedSection.classList.remove('hidden-page');
                setTimeout(() => feedSection.classList.add('active-page'), 10);
                fetchFeed(); 
            }
        }

        // ----- Search/Filter Logic -----
        window.filterFiles = function() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const feed = document.getElementById('feed');
            const items = feed.getElementsByClassName('feed-item');

            for (let i = 0; i < items.length; i++) {
                const titleElement = items[i].querySelector('h3');
                const origElement = items[i].querySelector('.orig-name');
                if (titleElement) {
                    const txtValue = (titleElement.textContent || "") + (origElement ? origElement.textContent : "");
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        items[i].style.display = "";
                    } else {
                        items[i].style.display = "none";
                    }
                }
            }
        }

        // ----- Confirm Add File -----
        window.confirmAddFile = function() {
            if(confirm("Do you want to add a new file?")) {
                toggleView('upload');
            }
        }

        window.updateFileName = function(input) {
            const label = document.getElementById('fileLabel');
            if(input.files && input.files[0]) {
                label.innerHTML = `<span class="text-brand-600 font-bold">${input.files[0].name}</span>`;
            }
        }

        // ----- Upload Logic -----
        async function upload() {
            const btn = document.getElementById("uploadBtn");
            const originalText = btn.innerHTML;
            
            const fileInput = document.getElementById("file").files[0];
            const password = document.getElementById("password").value.trim();
            const filename = document.getElementById("filename").value.trim();
            
            const progressContainer = document.getElementById("progressContainer");
            const progressBar = document.getElementById("progressBar");
            const progressText = document.getElementById("progressText");

            if (!fileInput || !password || !filename) {
                alert("‚ö†Ô∏è Please fill all fields");
                return;
            }

            // Capture Metadata for DB
            const originalName = fileInput.name;
            const fileSizeFormatted = formatBytes(fileInput.size);

            // Disable button
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            
            // Show Progress Bar
            progressContainer.classList.remove("hidden");
            progressBar.style.width = "0%";
            progressText.innerText = "0%";

            // Prepare Data
            const formData = new FormData();
            formData.append("file", fileInput);
            formData.append("upload_preset", uploadPreset);
            formData.append("resource_type", "auto"); 

            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener("progress", (event) => {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percent + "%";
                    progressText.innerText = percent + "%";
                }
            });

            xhr.onload = async () => {
                if (xhr.status === 200) {
                    try {
                        const cloudData = JSON.parse(xhr.responseText);
                        
                        // Save to Supabase including new columns
                        const { error } = await supabase.from('posts').insert([{
                            title: filename + "_" + password,
                            filename, // This is your custom title input
                            password,
                            file_url: cloudData.secure_url,
                            views: 0,
                            original_name: originalName, // Saved original filename
                            file_size: fileSizeFormatted  // Saved formatted size
                        }]);

                        if (error) throw error;

                        alert("Upload successful! üéâ");
                        document.getElementById("filename").value = "";
                        document.getElementById("file").value = "";
                        document.getElementById("password").value = "";
                        document.getElementById("fileLabel").innerText = "Click to choose file";
                        
                        toggleView('feed');

                    } catch (err) {
                        console.error(err);
                        alert("Database Error: " + err.message);
                    }
                } else {
                    alert("Upload Failed. Cloudinary Error.");
                }
                
                resetUploadUI();
            };

            xhr.onerror = () => {
                alert("Network Error during upload.");
                resetUploadUI();
            };

            xhr.open("POST", `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`);
            xhr.send(formData);

            function resetUploadUI() {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                progressContainer.classList.add("hidden");
            }
        }

        // ----- Feed -----
        async function fetchFeed() {
            const loader = document.getElementById("loader");
            const feed = document.getElementById("feed");
            
            if(feed.children.length === 0) loader.style.display = "block";

            const { data, error } = await supabase.from('posts')
                .select('*')
                .order('views', { ascending:false })
                .order('upload_time', { ascending:false });
            
            loader.style.display = "none";
            
            if (error) { 
                feed.innerHTML = `<div class="bg-white/10 text-white p-4 rounded-xl text-center backdrop-blur-md">Failed to load feed.</div>`;
                return; 
            }

            feed.innerHTML = "";

            if (data.length === 0) {
                feed.innerHTML = `
                    <div class="glass-panel p-10 rounded-2xl text-center">
                        <i class="fa-solid fa-box-open text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 font-medium">No files available yet.</p>
                        <button onclick="confirmAddFile()" class="mt-4 text-brand-600 font-bold text-sm hover:underline">Upload First File</button>
                    </div>`;
                return;
            }

            data.forEach(post => {
                const age = new Date() - new Date(post.upload_time);
                const expired = age > 48*60*60*1000;

                const dateObj = new Date(post.upload_time);
                const dateStr = dateObj.toLocaleDateString(undefined, { month:'short', day:'numeric' });
                
                let iconClass = "fa-file-lines text-gray-500";
                let bgClass = "bg-gray-100";
                const fn = (post.original_name || "").toLowerCase();
                
                if(fn.includes('pdf')) { iconClass = "fa-file-pdf text-red-500"; bgClass = "bg-red-50"; }
                else if(fn.match(/\.(jpg|jpeg|png|webp)$/)) { iconClass = "fa-file-image text-purple-500"; bgClass = "bg-purple-50"; }
                else if(fn.match(/\.(doc|docx)$/)) { iconClass = "fa-file-word text-blue-500"; bgClass = "bg-blue-50"; }
                else if(fn.match(/\.(zip|rar|7z)$/)) { iconClass = "fa-file-zipper text-orange-500"; bgClass = "bg-orange-50"; }

                const div = document.createElement("div");
                div.className = `feed-item glass-panel p-4 sm:p-5 rounded-2xl transition-all duration-300 ${expired ? 'opacity-60 grayscale' : 'hover:scale-[1.01] hover:shadow-xl'}`;

                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl ${bgClass} flex items-center justify-center shrink-0 shadow-sm">
                            <i class="fa-regular ${iconClass} text-2xl"></i>
                        </div>
                        
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-800 text-lg truncate pr-2">${post.filename}</h3>
                                ${!expired ? `<span class="shrink-0 text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full border border-green-200">ACTIVE</span>` : ''}
                            </div>
                            
                            <p class="orig-name text-[10px] text-gray-400 font-bold truncate mb-1 italic opacity-80">
                                <i class="fa-solid fa-paperclip mr-1"></i> ${post.original_name || 'unknown_file'}
                            </p>

                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500 font-medium">
                                <span>${dateStr}</span>
                                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                <span class="text-brand-600 font-bold">${post.file_size || '0 KB'}</span>
                                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                <span>${post.views} views</span>
                                ${expired ? `<span class="w-1 h-1 bg-gray-300 rounded-full"></span><span class="text-red-500">Expired</span>` : ''}
                            </div>
                        </div>

                        <div class="shrink-0">
                            ${expired 
                                ? `<button disabled class="w-10 h-10 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center cursor-not-allowed"><i class="fa-solid fa-ban"></i></button>`
                                : `<button onclick="openFile('${post.password}','${post.file_url}', '${(post.original_name || post.filename).replace(/'/g, "\\'")}')" class="w-10 h-10 rounded-full bg-brand-50 text-brand-600 hover:bg-brand-600 hover:text-white flex items-center justify-center transition-colors shadow-sm border border-brand-100">
                                    <i class="fa-solid fa-lock-open"></i>
                                   </button>`
                            }
                        </div>
                    </div>
                `;
                feed.appendChild(div);
            });
        }

        // ----- Modal & Action Logic -----
        window.openFile = async function(passwordInput, fileUrl, fileName) {
            const input = prompt("üîê Enter file password:");
            if (input !== passwordInput) {
                alert("‚ùå Wrong password");
                return;
            }

            try {
                const { data: posts } = await supabase.from('posts').select('views').eq('file_url', fileUrl).single();
                await supabase.from('posts').update({ views: (posts.views || 0) + 1 }).eq('file_url', fileUrl);
                
                const modal = document.getElementById('actionModal');
                const nameEl = document.getElementById('modalFileName');
                const downloadBtn = document.getElementById('downloadLink');

                modal.classList.remove('hidden');
                nameEl.textContent = fileName;
                
                downloadBtn.href = fileUrl;
                downloadBtn.download = fileName; 

                if(window.resetStars) {
                    currentRating = 0;
                    resetStars();
                    document.getElementById('ratingMessage').classList.add('opacity-0');
                }

            } catch (err) {
                console.error(err);
                alert("Error connecting to server");
            }
        };

        window.closeModal = function() {
            document.getElementById('actionModal').classList.add('hidden');
        }

        document.getElementById('actionModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // -------------------------
        // STAR RATING LOGIC
        // -------------------------
        let currentRating = 0;

        window.highlightStars = function(count) {
            const buttons = document.querySelectorAll('.star-btn');
            buttons.forEach((btn, index) => {
                const icon = btn.querySelector('i');
                if (index < count) {
                    icon.classList.remove('fa-regular', 'text-gray-300');
                    icon.classList.add('fa-solid', 'text-yellow-400');
                } else {
                    icon.classList.remove('fa-solid', 'text-yellow-400');
                    icon.classList.add('fa-regular', 'text-gray-300');
                }
            });
        }

        window.resetStars = function() {
            highlightStars(currentRating);
        }

        window.submitRating = function(rating) {
            currentRating = rating;
            highlightStars(rating);
            const msg = document.getElementById('ratingMessage');
            msg.innerText = `You rated us ${rating} stars!`;
            msg.classList.remove('opacity-0');
            setTimeout(() => { msg.classList.add('opacity-0'); }, 3000);
        }

    </script>
</body>
</html>
