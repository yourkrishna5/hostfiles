<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareWithCNR | Secure Vault</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { brand: { 500: '#6366f1', 600: '#4f46e5' }, dark: '#0f172a' }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            color: #f8fafc;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .hidden-page { display: none; opacity: 0; }
        .active-page { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <div id="actionModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-2xl max-w-sm w-full mx-4 text-center relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="w-16 h-16 bg-brand-50 rounded-full flex items-center justify-center mx-auto mb-4 text-brand-600"><i class="fa-solid fa-unlock-keyhole text-2xl"></i></div>
            <h3 class="text-xl font-bold text-gray-800 mb-1">Access Granted</h3>
            <p id="modalFileName" class="text-sm text-gray-500 font-medium mb-6 truncate px-2"></p>
            <a id="downloadLink" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full py-3 bg-brand-600 text-white rounded-xl font-semibold shadow-lg">Download File</a>
        </div>
    </div>

    <nav class="sticky top-0 z-50 bg-dark/80 backdrop-blur-md border-b border-white/10">
        <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-brand-600 flex items-center justify-center text-white"><i class="fa-solid fa-share-nodes"></i></div>
                <h1 class="text-xl font-bold text-white">ShareWithCNR</h1>
            </div>
        </div>
    </nav>

    <main class="flex-grow container max-w-3xl mx-auto px-4 py-8">
        
        <div id="feedSection" class="active-page">
            <div class="flex flex-col items-center mb-8 text-center">
                <h2 class="text-3xl font-bold mb-2">Available Files</h2>
                <input type="text" id="searchInput" onkeyup="filterFiles()" placeholder="Search files..." 
                    class="block w-full max-w-md mt-4 px-4 py-3 rounded-xl glass-dark text-white outline-none border border-white/10">
            </div>

            <div id="loader" class="hidden text-center py-12"><div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-white/20 border-t-brand-500"></div></div>
            <div id="feed" class="space-y-4"></div>
        </div>

        <div id="uploadSection" class="hidden-page">
            <div class="max-w-lg mx-auto">
                <button onclick="toggleView('feed')" class="mb-6 flex items-center text-white/80 hover:text-white">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Back to Feed
                </button>

                <div class="glass-panel rounded-2xl p-8 shadow-2xl">
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Upload File</h2>
                    <div class="space-y-5">
                        <input type="text" id="friendlyTitle" placeholder="Display Title (e.g. My Project)" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 outline-none focus:border-brand-500 text-gray-800">
                        
                        <label for="fileInput" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50">
                            <span id="fileLabel" class="text-gray-500">Select File</span>
                            <input type="file" id="fileInput" class="hidden" onchange="updateFileLabel()">
                        </label>

                        <input type="password" id="password" placeholder="Set Password" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 outline-none focus:border-brand-500 text-gray-800">
                        
                        <button id="uploadBtn" onclick="uploadFile()" class="w-full py-4 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 transition">Upload Now</button>
                        
                        <div id="progressContainer" class="hidden">
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                                <div id="progressBar" class="bg-brand-600 h-2 rounded-full w-0 transition-all"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button onclick="toggleView('upload')" id="fab" class="fixed bottom-8 left-8 w-14 h-14 rounded-full bg-brand-600 text-white flex items-center justify-center shadow-2xl border-2 border-white/20"><i class="fa-solid fa-plus"></i></button>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabase = createClient('https://sofxdshwkkwtfxnmlzem.supabase.co', 'sb_publishable_VMNVZXmmep05ihMaYjC9ug_FDxfoPL3');
        const CLOUD_NAME = "du1wbgmmh";
        const UPLOAD_PRESET = "fbpost";

        // Helpers
        const formatBytes = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        window.updateFileLabel = () => {
            const input = document.getElementById('fileInput');
            document.getElementById('fileLabel').innerText = input.files[0] ? input.files[0].name : "Select File";
        };

        window.toggleView = (view) => {
            document.getElementById('feedSection').className = view === 'feed' ? 'active-page' : 'hidden-page';
            document.getElementById('uploadSection').className = view === 'upload' ? 'active-page' : 'hidden-page';
            document.getElementById('fab').style.display = view === 'upload' ? 'none' : 'flex';
            if(view === 'feed') fetchFeed();
        };

        // --- UPLOAD ---
        window.uploadFile = async () => {
            const file = document.getElementById('fileInput').files[0];
            const title = document.getElementById('friendlyTitle').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('uploadBtn');

            if(!file || !title || !pass) return alert("Fill all fields");

            btn.disabled = true;
            btn.innerText = "Uploading...";
            document.getElementById('progressContainer').classList.remove('hidden');

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`);
            
            xhr.upload.onprogress = (e) => {
                const percent = (e.loaded / e.total) * 100;
                document.getElementById('progressBar').style.width = percent + "%";
            };

            xhr.onload = async () => {
                const cloudData = JSON.parse(xhr.responseText);
                
                // DATA INSERTION
                const { error } = await supabase.from('posts').insert([{
                    title: title,
                    password: pass,
                    file_url: cloudData.secure_url,
                    original_name: file.name,     // NEW COLUMN
                    file_size: formatBytes(file.size) // NEW COLUMN
                }]);

                if(error) alert("Database Error: " + error.message);
                else {
                    alert("Success!");
                    location.reload();
                }
            };
            xhr.send(formData);
        };

        // --- FEED ---
        async function fetchFeed() {
            const feed = document.getElementById('feed');
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');
            
            const { data, error } = await supabase.from('posts').select('*').order('upload_time', {ascending: false});
            loader.classList.add('hidden');

            if(error || !data) return;

            feed.innerHTML = data.map(post => `
                <div class="feed-item glass-panel p-5 rounded-2xl flex items-center gap-4 transition-all hover:scale-[1.01]">
                    <div class="w-12 h-12 rounded-xl bg-brand-50 flex items-center justify-center text-brand-600 shrink-0">
                        <i class="fa-solid fa-file-lines text-2xl"></i>
                    </div>
                    <div class="flex-grow min-w-0">
                        <h3 class="font-bold text-gray-800 text-lg truncate">${post.title}</h3>
                        <div class="flex flex-wrap items-center gap-2 mt-1">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded border border-gray-200 truncate max-w-[150px]">
                                <i class="fa-solid fa-paperclip mr-1"></i>${post.original_name || 'file'}
                            </span>
                            <span class="text-xs font-bold text-brand-600 bg-brand-50 px-2 py-0.5 rounded border border-brand-100">
                                ${post.file_size || 'N/A'}
                            </span>
                        </div>
                    </div>
                    <button onclick="openFile('${post.password}', '${post.file_url}', '${post.title}')" class="w-10 h-10 rounded-full bg-brand-600 text-white flex items-center justify-center">
                        <i class="fa-solid fa-lock-open"></i>
                    </button>
                </div>
            `).join('');
        }

        window.openFile = (correctPass, url, name) => {
            if(prompt("Enter Password") === correctPass) {
                document.getElementById('actionModal').classList.remove('hidden');
                document.getElementById('modalFileName').innerText = name;
                document.getElementById('downloadLink').href = url;
            } else {
                alert("Wrong password");
            }
        };

        window.closeModal = () => document.getElementById('actionModal').classList.add('hidden');

        fetchFeed();
    </script>
</body>
</html>
